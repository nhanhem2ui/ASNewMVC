@page "{id?}"
@model FUNewsManagement.Pages.Chat.ChatModel
@{
    ViewData["Title"] = "Chat";
    Layout = "_Layout";
}

<head>
    <link rel="stylesheet" href="~/css/Chat/Chat.css" />
</head>

<div class="container">
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2 class="sidebar-title">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                </svg>
                Previous Chats
            </h2>

            <div class="sidebar-content">
                <ul id="chatUsersList" class="chat-users-list">
                    @if (Model.ChatUsers != null && Model.ChatUsers.Any())
                    {
                        @foreach (var chatUser in Model.ChatUsers)
                        {
                            <li>
                                <button class="user-item @(Model.CurrentReceiver?.AccountId == chatUser.UserId ? "selected" : "")"
                                        onclick="selectUser('@chatUser.UserId', '@chatUser.UserName', '@Url.Content("/img/user.png")')">
                                    <div class="user-avatar-container">
                                        <div class="avatar">
                                            <img src="@Url.Content("/img/user.png")" alt="@chatUser.UserName" />
                                        </div>
                                        <div class="online-indicator hidden" data-user-id="@chatUser.UserId"></div>
                                    </div>
                                    <div class="user-info">
                                        <div class="user-header">
                                            <div class="user-name">@chatUser.UserName</div>
                                            @if (chatUser.LastMessageTime != null)
                                            {
                                                <div class="message-time">@chatUser.LastMessageTime.ToString("MM/dd HH:mm")</div>
                                            }
                                        </div>
                                        <div class="last-message">@chatUser.LastMessage</div>
                                        @if (chatUser.MessageCount > 0)
                                        {
                                            <div class="badge badge-neutral badge-sm">@chatUser.MessageCount</div>
                                        }
                                    </div>
                                </button>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="no-chats-message">No previous chats found</li>
                    }
                </ul>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <!-- Header -->
            <div id="chatHeader" class="chat-header">
                <div class="chat-header-content">
                    <div class="avatar avatar-sm">
                        <img id="receiverAvatar"
                             src="@Url.Content("/img/user.png")"
                             alt="Receiver Avatar" />
                    </div>
                    <span id="receiverName" class="receiver-name">
                        @if (Model.CurrentReceiver != null)
                        {
                            @Model.CurrentReceiver.AccountName
                        }
                        else
                        {
                            @:Select a chat to start messaging
                        }
                    </span>
                </div>
            </div>

            <!-- Messages -->
            <div class="messages-container" id="messagesContainer">
                @if (Model.CurrentReceiver != null && Model.ChatHistory != null && Model.ChatHistory.Any())
                {
                    @foreach (var message in Model.ChatHistory)
                    {
                        var isReceived = message.SenderId != Model.CurrentUser.AccountId;
                        <div class="chat @(isReceived ? "chat-start" : "chat-end")">
                            <div class="chat-image avatar">
                                <img src="@Url.Content(isReceived
                                                                         ? ("/img/user.png")
                                                                         : ("/img/user.png"))"
                             alt="@(isReceived? Model.CurrentReceiver.AccountName : Model.CurrentUser.AccountName)" />
                    </div>
                    <div class="chat-header">
                        @(isReceived? Model.CurrentReceiver.AccountName : Model.CurrentUser.AccountName)
                        <time class="message-timestamp">@message.Timestamp.ToString("HH:mm")</time>
                    </div>
                    <div class="chat-bubble @(isReceived ? "chat-bubble-primary" : "chat-bubble-secondary")">
                        @message.Message
                    </div>
                </div>
                                }
                }
                else if (Model.CurrentReceiver != null)
                {
                    <div class="empty-state">
                        <div class="chat chat-start">
                            <div class="chat-bubble chat-bubble-info">
                                Start your conversation with @Model.CurrentReceiver.AccountName
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <div class="chat chat-start">
                            <div class="chat-bubble chat-bubble-info">
                                Welcome to the chat! Select a conversation from the sidebar to start messaging.
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Input -->
            <div class="message-input-container">
                <form id="messageForm" class="message-form" onsubmit="return false;">
                    <input type="text" id="messageInput" placeholder="Type your message..."
                           class="input" maxlength="500"
                           @(Model.CurrentReceiver == null ? "disabled" : "") />
                    <button type="button" id="sendButton" class="btn btn-primary"
                            onclick="sendMessage()"
                            @(Model.CurrentReceiver == null ? "disabled" : "")>
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.429a1 1 0 001.17-1.409l-7-14z"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading + Toast -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading loading-spinner loading-lg"></div>
</div>
<div class="toast" id="toastContainer"></div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <script>
        let connection;
        let currentReceiverId = @Html.Raw(Model.CurrentReceiver?.AccountId != null ? $"'{Model.CurrentReceiver.AccountId}'" : "null");
        let currentUserId = '@Html.Raw(Model.CurrentUser?.AccountId)';
        let connectedUsers = [];

        const defaultAvatarUrl = '@Url.Content("/img/user.png")';
        const currentUserAvatar = '@Url.Content("/img/user.png")';
        const currentReceiverAvatar = '@Url.Content("/img/user.png")';
        const currentUserName = '@Html.Raw(Model.CurrentUser?.AccountName ?? "You")';

        async function initializeConnection() {
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/ChatHub")
                    .withAutomaticReconnect([0, 2000, 10000, 30000])
                    .build();

                connection.on("UpdatedConnectedUsers", users => updateOnlineStatus(users));
                connection.on("ReceiveMessage", (senderId, senderName, message, timestamp) => {
                    if (senderId === currentReceiverId || senderId === currentUserId) {
                        displayMessage(senderId, senderName, message, timestamp, senderId !== currentUserId);
                        scrollToBottom();
                    }
                });

                await connection.start();
                showToast("Connected to chat server", "success");
            } catch (err) {
                showToast("Failed to connect: " + err.message, "error");
            }
        }

        function updateOnlineStatus(users) {
            document.querySelectorAll('.online-indicator').forEach(ind => ind.classList.add('hidden'));
            users.forEach(user => {
                const indicator = document.querySelector('[data-user-id="' + user.userId + '"]');
                if (indicator) indicator.classList.remove('hidden');
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !currentReceiverId) return;

            try {
                input.value = '';
                await connection.invoke("SendMessage", currentReceiverId, message);
                displayMessage(currentUserId, currentUserName, message, new Date().toISOString(), false);
                scrollToBottom();
            } catch (err) {
                showToast("Error sending message: " + err.message, "error");
            }
        }

        function displayMessage(senderId, senderName, message, timestamp, isReceived) {
            const messages = document.getElementById('messagesContainer');
            const messageTime = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messageElement = document.createElement('div');
            messageElement.className = 'chat ' + (isReceived ? 'chat-start' : 'chat-end');
            messageElement.innerHTML = `
                <div class="chat-image avatar">
                    <img src="${isReceived ? currentReceiverAvatar : currentUserAvatar}" alt="${escapeHtml(senderName)}" />
                </div>
                <div class="chat-header">${escapeHtml(senderName)}<time class="message-timestamp">${messageTime}</time></div>
                <div class="chat-bubble ${isReceived ? 'chat-bubble-primary' : 'chat-bubble-secondary'}">${escapeHtml(message)}</div>
            `;
            messages.appendChild(messageElement);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const messages = document.getElementById('messagesContainer');
            messages.scrollTop = messages.scrollHeight;
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'alert alert-' + type;
            toast.innerHTML = `<div><span>${escapeHtml(message)}</span></div>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageForm').addEventListener('submit', e => {
                e.preventDefault();
                sendMessage();
            });
            initializeConnection();
        });

        window.selectUser = function(userId, userName, userAvatar) {
            window.location.href = '/Chat/Chat?id=' + userId;
    </script>
}